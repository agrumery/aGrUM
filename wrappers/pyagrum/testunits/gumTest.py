############################################################################
#   This file is part of the aGrUM/pyAgrum library.                        #
#                                                                          #
#   Copyright (c) 2005-2025 by                                             #
#       - Pierre-Henri WUILLEMIN(_at_LIP6)                                 #
#       - Christophe GONZALES(_at_AMU)                                     #
#                                                                          #
#   The aGrUM/pyAgrum library is free software; you can redistribute it    #
#   and/or modify it under the terms of either :                           #
#                                                                          #
#    - the GNU Lesser General Public License as published by               #
#      the Free Software Foundation, either version 3 of the License,      #
#      or (at your option) any later version,                              #
#    - the MIT license (MIT),                                              #
#    - or both in dual license, as here.                                   #
#                                                                          #
#   (see https://agrum.gitlab.io/articles/dual-licenses-lgplv3mit.html)    #
#                                                                          #
#   This aGrUM/pyAgrum library is distributed in the hope that it will be  #
#   useful, but WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,          #
#   INCLUDING BUT NOT LIMITED TO THE WARRANTIES MERCHANTABILITY or FITNESS #
#   FOR A PARTICULAR PURPOSE  AND NONINFRINGEMENT. IN NO EVENT SHALL THE   #
#   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER #
#   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,        #
#   ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  #
#   OTHER DEALINGS IN THE SOFTWARE.                                        #
#                                                                          #
#   See LICENCES for more details.                                         #
#                                                                          #
#   SPDX-FileCopyrightText: Copyright 2005-2025                            #
#       - Pierre-Henri WUILLEMIN(_at_LIP6)                                 #
#       - Christophe GONZALES(_at_AMU)                                     #
#   SPDX-License-Identifier: LGPL-3.0-or-later OR MIT                      #
#                                                                          #
#   Contact  : info_at_agrum_dot_org                                       #
#   homepage : http://agrum.gitlab.io                                      #
#   gitlab   : https://gitlab.com/agrumery/agrum                           #
#                                                                          #
############################################################################

import os
import platform
import sys
from sys import platform as os_platform

import logging


def go():
  cwd = os.getcwd()
  FORMAT = "[pyAgrum] %(asctime)s | %(levelname)s | %(filename)s:%(lineno)d | %(funcName)s | %(message)s"

  if os.path.isabs(__file__):
    os.chdir(os.path.dirname(__file__))
  else:
    os.chdir(os.path.dirname("./" + __file__))

  test_modules = {"", "main", "skbn", "causal", "clg", "ctbn", "bnmixture", "explain"}

  mod = "release"  # release|debug
  islocal = True  # installed|local : test the installed version
  testNotebooks = False
  test_module = ""  # all modules
  test_suite = ""  # if test_suite!="" => only this test suite

  parseM = 0
  parseT = 0

  for cde in sys.argv:
    match cde:
      case "debug" | "release":
        mod = cde
      case "installed" | "local":
        islocal = cde == "installed"
      case "-m":
        parseM = 1
        continue
      case "-t":
        parseT = 1
        continue
      case "all":
        if parseM == 1:
          testNotebooks = True
          parseM = 0
      case _:
        if parseM == 1:
          parseM = 0
          if cde.startswith("quick"):
            test_module = cde[6:]
            if test_module not in test_modules:
              print(f"[-m quick_module] but module '{test_module}' not in {test_modules}")
              sys.exit(1)
        elif parseT == 1:
          parseT = 0
          test_suite = cde

  logfilename = "/pyAgrumTests.log"
  if mod != "standAlone":
    logfilename = "/../../.." + logfilename
  logfilename = cwd + logfilename
  print(f"log : {logfilename}")

  log = logging.getLogger("gumTestLog")
  log.setLevel(logging.DEBUG)  # better to have too much log than not enough
  fh = logging.FileHandler(logfilename, mode="w", encoding=None, delay=False)
  fh.setFormatter(logging.Formatter(FORMAT))
  log.addHandler(fh)
  log.propagate = False

  log.info("Mode detected : " + mod)
  log.info("Testing notebooks : " + str(testNotebooks))

  if mod != "standAlone":
    if mod == "debug":
      libagrum = os.path.abspath("../../../build/pyAgrum/debug/wrappers")
    else:
      libagrum = os.path.abspath("../../../build/pyAgrum/release/wrappers")
    sys.path.insert(0, libagrum)  # to force using local pyAgrum for the tests (and not installed one)

  import pyagrum as gum

  total_errs = 0

  log.info("on Python {0} - {1}".format(platform.python_version(), os_platform))
  log.info("path : {}".format(gum.__file__))

  print("*****************")
  print("Python Test Suite")
  print("*****************")

  import testsOnPython

  total_errs += testsOnPython.runTests(local=islocal, test_module=test_module, test_suite=test_suite, log=log)

  if testNotebooks:
    log.info("Tests on notebooks")
    print("\n")
    print("*******************")
    print("Notebook Test Suite")
    print("*******************")
    from testsOnNotebooks import runNotebooks

    try:
      total_errs += runNotebooks()
    except NameError:
      pass
    except Exception as e:
      log.warning(f"Error in NotebookTestSuite : {e}")
      total_errs += 1
      print("=> Error in NotebookTestSuite")

  os.chdir(cwd)
  print("-" * 70)
  print(" log file ")
  print("-" * 70)
  with open(logfilename, "r") as logfile:
    for f in logfile.readlines():
      if "[pyAgrum]" in f:
        print(f, end="")
  print("-" * 70)

  print("\n\n\nErrors : " + str(total_errs))

  sys.exit(total_errs)


if __name__ == "__main__":
  go()
  sys.exit(0)
